apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: qa

# Reference base configuration
resources:
  - ../../base

# Name prefix for all resources
namePrefix: daybreak-app-

# Replace placeholders with actual values
replacements:
  - source:
      kind: ConfigMap
      name: app-config
      fieldPath: data.APP_NAME
    targets:
      - select:
          kind: ConfigMap
          name: app-config
        fieldPaths:
          - data.APP_NAME

# Patches to customize for daybreak-app
patches:
  # Update image
  - target:
      kind: Deployment
      name: app-deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: paulbouwer/hello-kubernetes:1.10
      - op: replace
        path: /metadata/labels/app
        value: daybreak-app
      - op: replace
        path: /spec/selector/matchLabels/app
        value: daybreak-app
      - op: replace
        path: /spec/template/metadata/labels/app
        value: daybreak-app
      - op: replace
        path: /spec/template/spec/containers/0/name
        value: daybreak-app
  
  # Update service selector
  - target:
      kind: Service
      name: app-service
    patch: |-
      - op: replace
        path: /metadata/labels/app
        value: daybreak-app
      - op: replace
        path: /spec/selector/app
        value: daybreak-app
  
  # Update ConfigMap
  - target:
      kind: ConfigMap
      name: app-config
    patch: |-
      - op: replace
        path: /data/APP_NAME
        value: daybreak-app

# Add labels specific to daybreak-app
commonLabels:
  app: daybreak-app
  component: frontend
